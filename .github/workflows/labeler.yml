name: labeler

on: [pull_request]

jobs:
  labeler:
    runs-on: ubuntu-latest
    name: Label the PR size
    steps:
      # Remove this step once the https://github.com/CodelyTV/pr-size-labeler/issues/96 is resolved
      - name: Remove legacy PR size labels
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const labelsToRemove = ['size/xs', 'size/s', 'size/m', 'size/l', 'size/xl'];
            const prLabels = context.payload.pull_request.labels.map(label => label.name);
            const labelsToRemoveSet = new Set(labelsToRemove);
            const labelsToKeep = issueLabels.filter(label => !labelsToRemoveSet.has(label));
            await github.issues.setLabels({
              ...context.repo,
              issue_number: context.payload.issue.number,
              labels: labelsToKeep
            });
      - uses: codelytv/pr-size-labeler@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          xs_label: "size/xs"
          xs_max_size: "10"
          s_label: "size/s"
          s_max_size: "100"
          m_label: "size/m"
          m_max_size: "500"
          l_label: "size/l"
          l_max_size: "1000"
          xl_label: "size/xl"
          fail_if_xl: "false"
          message_if_xl: >
            This PR exceeds the recommended size of 1000 lines.
            Please make sure you are NOT addressing multiple issues with one PR.
            Note this PR will be delayed and might be rejected due to its size.
          files_to_ignore: "generated/** pnpm-lock.yaml pg.d.ts"
